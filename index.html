<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beaded Font (opentype.js)</title>

  <style>
    /* THEME VARIABLES */
    :root{
      --bg: #000;
      --fg: #fff;
      --border: rgba(255,255,255,.15);
      --border-strong: rgba(255,255,255,.22);
      --panel-bg: rgba(255,255,255,.03);
      --panel-bg-2: rgba(255,255,255,.04);
      --input-bg: rgba(255,255,255,.06);
      --muted: rgba(255,255,255,.65);
      --hint: rgba(255,255,255,.55);
      --shadow: rgba(0,0,0,.35);

      /* switch */
      --switch-track: rgba(255,255,255,.18);
      --switch-track-on: rgba(255,255,255,.26);
      --switch-knob: rgba(255,255,255,.90);

      color-scheme: dark;
    }

    body{
      margin:0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display:grid; place-items:center; min-height:100vh;
    }

    .wrap{ width:min(1200px, 94vw); }

    /* ====== NAV TABS (Текст / Графика) ====== */
    .tabs{ display:flex; gap:10px; margin-bottom:2px; }
    .tab{
      flex:1;
      text-align:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: var(--panel-bg-2);
      color: var(--fg);
      text-decoration:none;
      font-size:14px;
    }
    .tab.active{
      border-color: var(--border-strong);
      background: var(--input-bg);
    }

    /* ====== PANEL ====== */
    .panel{
      display:grid; gap:10px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:14px; margin-bottom:12px;
      background: var(--panel-bg);
      box-shadow: 0 10px 30px var(--shadow);
    }

    .row{ display:flex; gap:12px; align-items:center; }
    .row > * { flex: 1; }

    .label{ opacity:.9; font-size:14px; color: var(--fg); }

    input[type="text"]{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--border-strong);
      background: var(--input-bg);
      color: var(--fg);
      outline:none;
    }
    input[type="text"]::placeholder{ color: var(--hint); }

    input[type="range"]{ width:100%; }

    .num{ width:70px; text-align:right; flex:0 0 auto; opacity:.9; color: var(--fg); }

    .toggles{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content: space-between;
    }

    .toggle{
      flex: 1 1 260px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: var(--panel-bg-2);
    }

    .toggle .left{
      display:flex; flex-direction:column; gap:2px;
      min-width: 0;
    }
    .toggle .title{ font-size:14px; color: var(--fg); }
    .toggle .hint{ font-size:12px; color: var(--muted); }

    /* Switch */
    .switch{
      position:relative;
      width:52px; height:30px;
      flex:0 0 auto;
    }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0;
      border-radius:999px;
      background: var(--switch-track);
      border:1px solid var(--border-strong);
      transition: .2s ease;
    }
    .slider:before{
      content:"";
      position:absolute; top:50%; left:4px;
      width:22px; height:22px;
      border-radius:999px;
      transform: translateY(-50%);
      background: var(--switch-knob);
      transition: .2s ease;
      box-shadow: 0 6px 16px var(--shadow);
    }
    .switch input:checked + .slider{
      background: var(--switch-track-on);
    }
    .switch input:checked + .slider:before{
      transform: translate(22px, -50%);
    }

    /* ====== STAGE ====== */
    .stage{
      border-radius:18px; overflow:hidden;
      border:1px solid var(--border);
      background: var(--bg);
      box-shadow: 0 18px 50px var(--shadow);
    }
    svg{ width:100%; height:auto; display:block; }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- =========================
         1) PANEL (управление)
         ========================= -->
    <div class="panel">

      <!-- Вкладки должны быть СРАЗУ ВНУТРИ .panel, первым блоком -->
      <div class="tabs">
        <a class="tab active" href="./text.html">Текст</a>
        <a class="tab" href="./graphics.html">Графика</a>
      </div>

      <div class="row">
        <div class="label">Текст</div>
        <input id="text" type="text" value="verite" />
      </div>

      <div class="row">
        <div class="label">Размер текста</div>
        <input id="size" type="range" min="60" max="260" value="180" />
        <div class="num"><span id="sizeVal">180</span></div>
      </div>

      <div class="row">
        <div class="label">Количество бусин</div>
        <input id="beads" type="range" min="0" max="260" value="20" />
        <div class="num"><span id="beadsVal">20</span></div>
      </div>

      <div class="toggles">
        <div class="toggle">
          <div class="left">
            <div class="title">Бусины</div>
            <div class="hint"><span id="beadsModeLabel">Цветные</span></div>
          </div>
          <label class="switch" title="Цветные / Белые">
            <input id="beadsMode" type="checkbox" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="toggle">
          <div class="left">
            <div class="title">Цвет текста</div>
            <div class="hint"><span id="textModeLabel">Белый текст · чёрный фон</span></div>
          </div>
          <label class="switch" title="Белый / Чёрный текст (фон меняется автоматически)">
            <input id="textMode" type="checkbox" />
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>
    <!-- конец .panel -->

    <!-- =========================
         2) STAGE (результат)
         ========================= -->
    <div class="stage">
      <svg id="svg" viewBox="0 0 1400 520" xmlns="http://www.w3.org/2000/svg">
        <rect id="bg" width="1400" height="520" fill="#000"/>

        <path id="outline"
              fill="none"
              stroke="#fff"
              stroke-width="10"
              stroke-linecap="round"
              stroke-linejoin="round" />

        <g id="beadsLayer"></g>
      </svg>
    </div>

  </div>

  <script src="https://unpkg.com/opentype.js@1.3.4/dist/opentype.min.js"></script>
  <script>
    const FONT_URL = "./Nostringsattatched-J2am.ttf"; // или .otf
    const COLORS = ["#00ADEF","#F88ED0","#FFF301","#3051C4","#DF1C02","#66FFB3","#7C4DFF","#9BE870"];
    const BEAD_RADIUS = 16;

    const root = document.documentElement;

    const bg = document.getElementById("bg");
    const outline = document.getElementById("outline");
    const beadsLayer = document.getElementById("beadsLayer");

    const textInp = document.getElementById("text");
    const sizeInp = document.getElementById("size");
    const beadsInp = document.getElementById("beads");

    const beadsModeInp = document.getElementById("beadsMode"); // OFF = цветные, ON = белые
    const textModeInp  = document.getElementById("textMode");  // OFF = белый текст/чёрный фон, ON = чёрный текст/белый фон

    const sizeVal = document.getElementById("sizeVal");
    const beadsVal = document.getElementById("beadsVal");
    const beadsModeLabel = document.getElementById("beadsModeLabel");
    const textModeLabel = document.getElementById("textModeLabel");

    function mulberry32(seed) {
      return function() {
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    let font = null;

    function setTheme(isLight){ // isLight = true => белый фон, чёрный текст
      if (isLight){
        root.style.setProperty("--bg", "#fff");
        root.style.setProperty("--fg", "#000");
        root.style.setProperty("--border", "rgba(0,0,0,.15)");
        root.style.setProperty("--border-strong", "rgba(0,0,0,.22)");
        root.style.setProperty("--panel-bg", "rgba(0,0,0,.03)");
        root.style.setProperty("--panel-bg-2", "rgba(0,0,0,.04)");
        root.style.setProperty("--input-bg", "rgba(0,0,0,.06)");
        root.style.setProperty("--muted", "rgba(0,0,0,.65)");
        root.style.setProperty("--hint", "rgba(0,0,0,.55)");
        root.style.setProperty("--shadow", "rgba(0,0,0,.10)");

        root.style.setProperty("--switch-track", "rgba(0,0,0,.12)");
        root.style.setProperty("--switch-track-on", "rgba(0,0,0,.18)");
        root.style.setProperty("--switch-knob", "rgba(0,0,0,.85)");
        root.style.colorScheme = "light";
      } else {
        root.style.setProperty("--bg", "#000");
        root.style.setProperty("--fg", "#fff");
        root.style.setProperty("--border", "rgba(255,255,255,.15)");
        root.style.setProperty("--border-strong", "rgba(255,255,255,.22)");
        root.style.setProperty("--panel-bg", "rgba(255,255,255,.03)");
        root.style.setProperty("--panel-bg-2", "rgba(255,255,255,.04)");
        root.style.setProperty("--input-bg", "rgba(255,255,255,.06)");
        root.style.setProperty("--muted", "rgba(255,255,255,.65)");
        root.style.setProperty("--hint", "rgba(255,255,255,.55)");
        root.style.setProperty("--shadow", "rgba(0,0,0,.35)");

        root.style.setProperty("--switch-track", "rgba(255,255,255,.18)");
        root.style.setProperty("--switch-track-on", "rgba(255,255,255,.26)");
        root.style.setProperty("--switch-knob", "rgba(255,255,255,.90)");
        root.style.colorScheme = "dark";
      }
    }

    function applyTheme() {
      const isLight = textModeInp.checked; // ON => чёрный текст, белый фон
      const textColor = isLight ? "#000" : "#fff";
      const bgColor   = isLight ? "#fff" : "#000";

      setTheme(isLight);

      bg.setAttribute("fill", bgColor);
      outline.setAttribute("stroke", textColor);

      textModeLabel.textContent = isLight ? "Чёрный текст · белый фон" : "Белый текст · чёрный фон";
      beadsModeLabel.textContent = beadsModeInp.checked ? "Белые" : "Цветные";
    }

    function buildPathData(text, fontSize) {
      const x0 = 60;
      const y0 = 360;
      const path = font.getPath(text, x0, y0, fontSize);
      const d = path.toPathData(3);

      const bbox = path.getBoundingBox();
      const targetCenterX = 700;
      const currentCenterX = (bbox.x1 + bbox.x2) / 2;
      const dx = targetCenterX - currentCenterX;

      return { d, dx };
    }

    function getBeadFill(rand) {
      if (beadsModeInp.checked) return "#fff";
      return COLORS[Math.floor(rand() * COLORS.length)];
    }

    function getBeadStroke() {
      const isLight = textModeInp.checked;
      return isLight ? "rgba(0,0,0,.18)" : "rgba(255,255,255,.18)";
    }

    function renderBeads(count, seed = 12345) {
      beadsLayer.innerHTML = "";
      beadsVal.textContent = String(count);

      const total = outline.getTotalLength();
      if (count <= 0 || !isFinite(total) || total <= 0) return;

      const rand = mulberry32(seed);
      const pad = total * 0.06;
      const start = pad;
      const end = Math.max(start + 1, total - pad);
      const span = end - start;

      const strokeCol = getBeadStroke();

      for (let i = 0; i < count; i++) {
        const t = (count === 1) ? 0.5 : i / (count - 1);
        const jitter = (rand() - 0.5) * 0.08;
        const dist = start + span * Math.min(1, Math.max(0, t + jitter));
        const p = outline.getPointAtLength(dist);

        const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        c.setAttribute("cx", p.x.toFixed(2));
        c.setAttribute("cy", p.y.toFixed(2));
        c.setAttribute("r", BEAD_RADIUS);

        c.setAttribute("fill", getBeadFill(rand));
        c.setAttribute("stroke", strokeCol);
        c.setAttribute("stroke-width", "2");

        beadsLayer.appendChild(c);
      }
    }

    function rerender() {
      if (!font) return;

      applyTheme();

      const text = textInp.value || "";
      const fontSize = parseInt(sizeInp.value, 10);
      const beadCount = parseInt(beadsInp.value, 10);

      sizeVal.textContent = String(fontSize);

      const { d, dx } = buildPathData(text, fontSize);

      outline.setAttribute("d", d);
      outline.setAttribute("transform", `translate(${dx},0)`);
      beadsLayer.setAttribute("transform", `translate(${dx},0)`);

      renderBeads(beadCount);
    }

    opentype.load(FONT_URL, function(err, loadedFont) {
      if (err) {
        console.error(err);
        alert("Не загрузился шрифт. Проверь, что файл лежит рядом с text.html и имя/расширение совпадают. Запускай через локальный сервер (Live Server / python -m http.server).");
        return;
      }
      font = loadedFont;
      rerender();
    });

    textInp.addEventListener("input", rerender);
    sizeInp.addEventListener("input", rerender);
    beadsInp.addEventListener("input", rerender);
    beadsModeInp.addEventListener("change", rerender);
    textModeInp.addEventListener("change", rerender);

    applyTheme();
  </script>
</body>
</html>
